name: ğŸ§± LEGO Weekly Maintenance

on:
  schedule:
    # Weekly check - Mondays at 21:12 CET (20:12 UTC)
    - cron: '12 20 * * MON'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ğŸ” Check for open dependency PRs
  dependency-check:
    name: ğŸ” Check LEGO Parts Status
    runs-on: ubuntu-latest

    steps:
      - name: Check for Dependabot PRs
        uses: actions/github-script@v8
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            const dependabotPRs = pullRequests.filter(pr =>
              pr.user.login === 'dependabot[bot]'
            );

            const prList = dependabotPRs.length > 0
              ? dependabotPRs.map(pr => `- [#${pr.number}](${pr.html_url}) - ${pr.title}`).join('\n')
              : 'No pending dependency updates';

            console.log(`Found ${dependabotPRs.length} Dependabot PRs`);
            console.log('PR List:', prList);

            // Create weekly maintenance issue
            const issueBody = `## ğŸ§± Weekly LEGO Maintenance Report - DNSSEC Validator

**Date:** ${new Date().toISOString().split('T')[0]}
**Dependency Status:** ${dependabotPRs.length} pending update(s)

### ğŸ“¦ Pending Dependency Updates:
${prList}

### ğŸ”’ Security Status:
See security audit job results for details.

---
*Automated weekly maintenance check for keeping our DNS security LEGO pieces up to date!* ğŸ§±ğŸ”’

**Next Check:** ${new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ§± Weekly Maintenance Report - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['maintenance', 'dependencies']
            });

  # ğŸ›¡ï¸ Security audit
  security-audit:
    name: ğŸ›¡ï¸ LEGO Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install safety bandit

      - name: Run Safety CLI security scan
        env:
          SAFETY_STAGE: production
        run: |
          safety scan --detailed-output > safety-report.txt || true
        continue-on-error: true

      - name: Run Bandit security analysis
        run: |
          bandit -r app/ -f json -o bandit-report.json || true
        continue-on-error: true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            safety-report.txt
            bandit-report.json
          retention-days: 30

      - name: Security audit complete
        run: echo "ğŸ›¡ï¸ Weekly security audit completed for DNSSEC Validator!"

  # ğŸ“Š Maintenance summary
  maintenance-summary:
    name: ğŸ“Š LEGO Maintenance Summary
    runs-on: ubuntu-latest
    needs: [dependency-check, security-audit]
    if: always()

    steps:
      - name: Post summary
        uses: actions/github-script@v8
        with:
          script: |
            const needs = ${{ toJson(needs) }};

            const dependencyStatus = needs['dependency-check'].result === 'success' ? 'âœ…' : 'âŒ';
            const securityStatus = needs['security-audit'].result === 'success' ? 'âœ…' : 'âŒ';

            console.log('ğŸ§± Weekly LEGO Maintenance Summary:');
            console.log(`${dependencyStatus} Dependency Check: ${needs['dependency-check'].result}`);
            console.log(`${securityStatus} Security Audit: ${needs['security-audit'].result}`);
            console.log('');
            console.log('Next maintenance check: ' + new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
            console.log('');
            console.log('ğŸ”’ Building better DNS security, one LEGO brick at a time!');
