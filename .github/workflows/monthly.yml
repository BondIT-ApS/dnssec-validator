name: Monthly Release Creation

# Creates monthly production releases (YY.M.0) on the 1st of each month
# Runs automatically at 04:00 CET (03:00 UTC during summer, 02:00 UTC during winter)
# Can also be triggered manually

on:
  schedule:
    - cron: '0 3 1 * *'  # Run at 03:00 UTC on 1st of each month (04:00 CET)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create-monthly-release:
    name: "ðŸŽ‰ Create Monthly Release"
    runs-on: ubuntu-latest
    
    steps:
    - name: "ðŸ“¦ Checkout Repository"
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        
    - name: "ðŸ”¢ Determine Release Version"
      id: version
      run: |
        # Get current YY.M
        CURRENT_MONTH=$(date +"%y.%-m")
        
        # Create release version (YY.M.0)
        RELEASE_VERSION="${CURRENT_MONTH}.0"
        
        echo "release_version=$RELEASE_VERSION" >> "$GITHUB_OUTPUT"
        
        echo "ðŸ“‹ Version Information:"
        echo "   Release Version: $RELEASE_VERSION"

    - name: "ðŸ·ï¸ Create Release Tag"
      env:
        RELEASE_VERSION: ${{ steps.version.outputs.release_version }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if tag already exists
        if git tag -l | grep -q "^${RELEASE_VERSION}$"; then
          echo "âš ï¸ Tag ${RELEASE_VERSION} already exists, skipping"
          exit 0
        fi
        
        # Create annotated tag
        git tag -a "$RELEASE_VERSION" -m "Monthly Release $RELEASE_VERSION

        Monthly production release for $(date +"%B %Y")

        Build: GitHub Actions #${GITHUB_RUN_NUMBER}
        Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        "
        
        # Push tag
        git push origin "$RELEASE_VERSION"
        
        echo "âœ… Created and pushed tag: $RELEASE_VERSION"

    - name: "ðŸ“¦ Create GitHub Release"
      env:
        RELEASE_VERSION: ${{ steps.version.outputs.release_version }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Create release notes
        cat > temp_release_notes.md << EOF
        # Monthly Release ${RELEASE_VERSION}
        
        **Release Date:** $(date +"%Y-%m-%d")
        **Release Type:** Monthly Release
        
        ## Overview
        
        Monthly production release for $(date +"%B %Y").
        
        ## Docker Images
        
        \`\`\`bash
        docker pull maboni82/dnssec-validator:${RELEASE_VERSION}
        docker pull maboni82/dnssec-validator:latest
        \`\`\`
        
        ## Technical Details
        
        - **Git Tag:** \`${RELEASE_VERSION}\`
        - **Build:** GitHub Actions #${GITHUB_RUN_NUMBER}
        - **Platforms:** linux/amd64, linux/arm64
        
        EOF
        
        # Create GitHub release
        gh release create "$RELEASE_VERSION" \
          --title "Monthly Release $RELEASE_VERSION" \
          --notes-file "temp_release_notes.md" \
          --target main
        
        echo "âœ… Created GitHub release: $RELEASE_VERSION"

  summary:
    name: "ðŸ“‹ Release Summary"
    needs: create-monthly-release
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: "ðŸ“‹ Generate Summary"
      run: |
        echo "## ðŸš€ Monthly Release Summary" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "**Trigger:** ${{ github.event_name }}" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        
        if [[ "${{ needs.create-monthly-release.result }}" == "success" ]]; then
          echo "### âœ… Actions Completed" >> "$GITHUB_STEP_SUMMARY"
          echo "- ðŸ·ï¸ Created monthly release tag" >> "$GITHUB_STEP_SUMMARY"
          echo "- ðŸ“¦ Created GitHub release" >> "$GITHUB_STEP_SUMMARY"
          
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ðŸ”„ Next Steps" >> "$GITHUB_STEP_SUMMARY"
          echo "- Docker publish workflow will build and push the Docker image" >> "$GITHUB_STEP_SUMMARY"
          echo "- Image will be available as monthly release version" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "### âŒ Release Failed" >> "$GITHUB_STEP_SUMMARY"
          echo "Monthly release creation failed. Please check logs for details." >> "$GITHUB_STEP_SUMMARY"
        fi

