name: Auto-Increment Version on PR Merge

# Automatically increments patch version when PR is merged to main branch
# Handles YY.M.PATCH versioning (e.g., 26.1.1, 26.1.2, etc.)
# Monthly releases (YY.M.0) are handled by monthly.yml workflow

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_version:
        description: 'Force specific version (e.g., 26.1.15)'
        required: false
        type: string

# Allow only one concurrent version increment
concurrency:
  group: ${{ github.workflow }}-version-increment
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: read
  actions: read

jobs:
  calculate-version:
    name: "ðŸ”¢ Calculate Next Version"
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      latest_version: ${{ steps.version.outputs.latest_version }}
      current_month: ${{ steps.version.outputs.current_month }}
      should_build: ${{ steps.check.outputs.should_build }}
      
    steps:
    - name: "ðŸ“¦ Checkout Repository"
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Need full history for tag analysis
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: "ðŸ”¢ Calculate Version"
      id: version
      run: |
        if [[ -n "${{ github.event.inputs.force_version }}" ]]; then
          # Manual trigger with forced version
          NEW_VERSION="${{ github.event.inputs.force_version }}"
          echo "ðŸŽ¯ Using forced version: $NEW_VERSION"
          
          # Validate format
          if ! [[ "$NEW_VERSION" =~ ^[0-9]{2}\.[0-9]{1,2}\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $NEW_VERSION"
            echo "Expected format: YY.M.PATCH (e.g., 26.1.15)"
            exit 1
          fi
          
          # Get latest for comparison
          CURRENT_MONTH=$(date +"%y.%-m")
          LATEST_VERSION=$(git tag -l "${CURRENT_MONTH}.*" | sort -V | tail -1)
          if [[ -z "$LATEST_VERSION" ]]; then
            LATEST_VERSION="${CURRENT_MONTH}.0"
          fi
        else
          # Use increment script for automatic versioning
          chmod +x scripts/increment-version.sh
          ./scripts/increment-version.sh
          
          # Script outputs to stdout, capture it
          NEW_VERSION=$(./scripts/increment-version.sh | tail -1)
          
          # Get previous version
          CURRENT_MONTH=$(date +"%y.%-m")
          LATEST_VERSION=$(git tag -l "${CURRENT_MONTH}.*" | sort -V | tail -1)
          if [[ -z "$LATEST_VERSION" ]]; then
            LATEST_VERSION="${CURRENT_MONTH}.0"
          fi
        fi
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT  
        echo "current_month=$(echo "$NEW_VERSION" | cut -d. -f1-2)" >> $GITHUB_OUTPUT
        
        echo "ðŸ“‹ Version Calculation:"
        echo "   Previous: $LATEST_VERSION"
        echo "   Next: $NEW_VERSION"

    - name: "ðŸ” Check if Version Already Exists"
      id: check
      env:
        NEW_VERSION: ${{ steps.version.outputs.new_version }}
      run: |
        if git tag -l | grep -q "^${NEW_VERSION}$"; then
          echo "âš ï¸ Version tag already exists: $NEW_VERSION"
          if [[ "${{ github.event.inputs.force_version }}" == "$NEW_VERSION" ]]; then
            echo "ðŸ”„ Force mode - will overwrite existing tag"
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ Skipping build for existing version"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "âœ… New version ready: $NEW_VERSION"
          echo "should_build=true" >> $GITHUB_OUTPUT
        fi

  create-tag-and-release:
    name: "ðŸ·ï¸ Create Tag and Release"
    runs-on: ubuntu-latest
    needs: calculate-version
    if: needs.calculate-version.outputs.should_build == 'true'
      
    steps:
    - name: "ðŸ“¦ Checkout Repository"
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: "ðŸ·ï¸ Create Git Tag"
      env:
        NEW_VERSION: ${{ needs.calculate-version.outputs.new_version }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Delete existing tag if force mode
        if git tag -l | grep -q "^${NEW_VERSION}$"; then
          echo "ðŸ”„ Removing existing tag: $NEW_VERSION"
          git tag -d "$NEW_VERSION" || true
          git push origin ":refs/tags/$NEW_VERSION" || true
        fi
        
        # Create annotated tag
        git tag -a "$NEW_VERSION" -m "Patch release $NEW_VERSION

        Automatic patch version increment from main branch merge.
        
        Build: GitHub Actions #${GITHUB_RUN_NUMBER}
        Commit: ${GITHUB_SHA:0:8}
        Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        "
        
        # Push tag
        git push origin "$NEW_VERSION"
        
        echo "âœ… Created and pushed tag: $NEW_VERSION"

    - name: "ðŸ“¦ Create GitHub Release"
      env:
        NEW_VERSION: ${{ needs.calculate-version.outputs.new_version }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Create release notes
        cat > temp_release_notes.md << EOF
        # Release ${NEW_VERSION}
        
        **Release Date:** $(date +"%Y-%m-%d")
        **Release Type:** Patch Release
        **Commit:** ${GITHUB_SHA:0:8}
        
        ## Changes
        
        Automatic patch release from main branch merge.
        
        ## Docker Images
        
        \`\`\`bash
        docker pull maboni82/dnssec-validator:${NEW_VERSION}
        docker pull maboni82/dnssec-validator:latest
        \`\`\`
        
        ## Technical Details
        
        - **Git Tag:** \`${NEW_VERSION}\`
        - **Build:** GitHub Actions #${GITHUB_RUN_NUMBER}
        - **Docker Build:** Handled by docker-publish workflow
        
        EOF
        
        # Create GitHub release
        gh release create "$NEW_VERSION" \
          --title "Release $NEW_VERSION" \
          --notes-file "temp_release_notes.md" \
          --target main
        
        echo "âœ… Created GitHub release: $NEW_VERSION"

  summary:
    name: "ðŸ“‹ Version Summary"
    runs-on: ubuntu-latest
    needs: [calculate-version, create-tag-and-release]
    if: always()
    
    steps:
    - name: "ðŸ“‹ Generate Summary"
      env:
        NEW_VERSION: ${{ needs.calculate-version.outputs.new_version }}
        SHOULD_BUILD: ${{ needs.calculate-version.outputs.should_build }}
      run: |
        echo "## ðŸš€ Version Increment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** $NEW_VERSION" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Tag Created:** $SHOULD_BUILD" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "$SHOULD_BUILD" == "true" ]]; then
          echo "### âœ… Actions Completed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ·ï¸ Created git tag: \`$NEW_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Created GitHub release" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Docker publish workflow will automatically build and push Docker image" >> $GITHUB_STEP_SUMMARY
          echo "- Image will be tagged as: \`${NEW_VERSION}\`, \`latest\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "### â„¹ï¸ No Action Required" >> $GITHUB_STEP_SUMMARY
          echo "Version \`$NEW_VERSION\` already exists or no changes detected." >> $GITHUB_STEP_SUMMARY
        fi
