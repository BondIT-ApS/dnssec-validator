<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNSSEC Detailed Analysis - {{ domain or 'DNSSEC Validator' }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .detailed-analysis {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
        }
        .section-header {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 600;
        }
        .subsection {
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .subsection h4 {
            color: #34495e;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            overflow-x: auto;
            margin: 10px 0;
        }
        .algorithm-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 10px 0;
        }
        .algorithm-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            min-width: 200px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .algorithm-card.excellent { border-left: 4px solid #27ae60; }
        .algorithm-card.good { border-left: 4px solid #f39c12; }
        .algorithm-card.weak { border-left: 4px solid #e74c3c; }
        .algorithm-card.unknown { border-left: 4px solid #95a5a6; }
        
        .troubleshooting {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .troubleshooting h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        .troubleshooting ul {
            margin: 0;
            padding-left: 20px;
        }
        .troubleshooting li {
            margin: 5px 0;
            color: #856404;
        }
        
        .recommendations {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .recommendations h4 {
            color: #155724;
            margin-bottom: 10px;
        }
        .recommendations ul {
            margin: 0;
            padding-left: 20px;
        }
        .recommendations li {
            margin: 5px 0;
            color: #155724;
        }
        
        .dns-query {
            margin: 15px 0;
        }
        .query-header {
            background: #495057;
            color: white;
            padding: 8px 12px;
            border-radius: 3px 3px 0 0;
            font-weight: 600;
            font-size: 0.9em;
        }
        .query-response {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-top: none;
            padding: 10px;
            border-radius: 0 0 3px 3px;
            font-family: monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        
        .timing-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-valid { background-color: #28a745; }
        .status-invalid { background-color: #dc3545; }
        .status-insecure { background-color: #6c757d; }
        .status-error { background-color: #ffc107; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .back-link {
            display: inline-block;
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 0.9em;
            transition: background 0.3s;
        }
        .back-link:hover {
            background: #5a6268;
            color: white;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
            <h1 style="margin: 0;">DNSSEC Detailed Analysis</h1>
            <nav style="display: flex; gap: 10px;">
                <a href="/" class="back-link">‚Üê Back to Validator</a>
                <a href="/stats" style="padding: 8px 16px; background: #3498db; color: white; text-decoration: none; border-radius: 4px; font-size: 0.9em; transition: background 0.3s;" 
                   onmouseover="this.style.background='#2980b9'" onmouseout="this.style.background='#3498db'">üìä Analytics</a>
                <a href="/api/docs/" style="padding: 8px 16px; background: #27ae60; color: white; text-decoration: none; border-radius: 4px; font-size: 0.9em; transition: background 0.3s;"
                   onmouseover="this.style.background='#219a52'" onmouseout="this.style.background='#27ae60'">üìñ API Docs</a>
            </nav>
        </header>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h2 style="margin: 0 0 10px 0; color: #2c3e50;">
                Domain: <span id="domain-name">{{ domain or 'Enter domain below' }}</span>
            </h2>
            <p style="margin: 0; color: #6c757d;">
                Comprehensive technical analysis with raw DNS data, algorithm assessment, and troubleshooting guidance
            </p>
        </div>
        
        {% if not domain %}
        <form id="dnssec-form" style="margin-bottom: 30px;">
            <input type="text" id="domain-input" placeholder="Enter a domain name (e.g., bondit.dk)" required style="width: 70%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
            <button type="submit" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 4px; font-size: 1em; cursor: pointer;">Analyze Domain</button>
        </form>
        {% endif %}
        
        <div id="results-container">
            {% if domain %}
            <div class="loading">
                <div class="spinner"></div>
                <p>Performing detailed DNSSEC analysis...</p>
                <p style="font-size: 0.9em; color: #999;">This may take a few seconds as we gather comprehensive data</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <script>
        // Feature flags
        window.SHOW_TLSA_DANE = {{ 'true' if show_tlsa_dane else 'false' }};
        
        let currentDomain = {{ domain|tojson if domain else "null" }};
        
        document.addEventListener('DOMContentLoaded', function() {
            {% if domain %}
            performDetailedAnalysis({{ domain|tojson }});
            {% endif %}
            
            const form = document.getElementById('dnssec-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const domain = document.getElementById('domain-input').value.trim();
                    if (domain) {
                        window.location.href = '/' + domain + '/detailed';
                    }
                });
            }
        });
        
        function performDetailedAnalysis(domain) {
            console.log('üîç Starting detailed analysis for domain:', domain);
            const container = document.getElementById('results-container');
            
            if (!container) {
                console.error('‚ùå Results container not found!');
                return;
            }
            
            // Show loading state
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Performing detailed DNSSEC analysis for <strong>${domain}</strong>...</p>
                    <p style="font-size: 0.9em; color: #999;">This may take a few seconds as we gather comprehensive data</p>
                </div>
            `;
            
            const apiUrl = `/api/validate/${domain}/detailed`;
            console.log('üì° Making API call to:', apiUrl);
            
            fetch(apiUrl, {
                headers: {
                    'X-Client': 'webapp'
                }
            })
            .then(response => {
                console.log('üì• Response received:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ Data received:', data);
                console.log('üîß Calling displayDetailedResults...');
                displayDetailedResults(data);
            })
            .catch(error => {
                console.error('‚ùå Error in detailed analysis:', error);
                container.innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; padding: 15px; color: #721c24;">
                        <h3>‚ö†Ô∏è Analysis Failed</h3>
                        <p>Unable to perform detailed analysis: ${error.message}</p>
                        <p><small>Check browser console for details</small></p>
                        <button onclick="performDetailedAnalysis('${domain}')" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Retry Analysis</button>
                    </div>
                `;
            });
        }
        
        function displayDetailedResults(data) {
            console.log('üé® displayDetailedResults called with data:', data);
            const container = document.getElementById('results-container');
            
            try {
                const statusClass = getStatusClass(data.status);
                const statusIcon = getStatusIcon(data.status);
            
            let html = `
                <div class="detailed-analysis">
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <span class="status-indicator status-${data.status}"></span>
                        <h2 style="margin: 0; color: #2c3e50;">${statusIcon} Status: ${data.status.toUpperCase()}</h2>
                    </div>
            `;
            
            // Basic validation summary
            html += `
                <div class="section-header">üîç Validation Summary</div>
                <div class="subsection">
                    <p><strong>Domain:</strong> ${data.domain}</p>
                    <p><strong>Status:</strong> ${data.status}</p>
                    <p><strong>Analysis Time:</strong> ${new Date(data.validation_time).toLocaleString()}</p>
                </div>
            `;
            
            // Chain of Trust
            if (data.chain_of_trust && data.chain_of_trust.length > 0) {
                html += `
                    <div class="section-header">üîó Chain of Trust</div>
                    <div class="subsection">
                `;
                data.chain_of_trust.forEach(chain => {
                    const chainStatus = getStatusClass(chain.status);
                    html += `
                        <div style="margin: 10px 0; padding: 10px; border-left: 4px solid ${getStatusColor(chain.status)}; background: #f8f9fa;">
                            <strong>${chain.zone}</strong>: ${chain.status}
                            ${chain.algorithm ? `<br><small>Algorithm: ${chain.algorithm}, Key Tag: ${chain.key_tag}</small>` : ''}
                            ${chain.error ? `<br><small style="color: #dc3545;">Error: ${chain.error}</small>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Algorithm Analysis
            if (data.detailed_analysis && data.detailed_analysis.algorithm_analysis) {
                html += `
                    <div class="section-header">üîê Algorithm Analysis</div>
                    <div class="subsection">
                `;
                Object.entries(data.detailed_analysis.algorithm_analysis).forEach(([algId, info]) => {
                    const strengthColor = info.strength === 'excellent' ? '#27ae60' : info.strength === 'good' ? '#f39c12' : info.strength === 'weak' ? '#e74c3c' : '#6c757d';
                    html += `
                        <div style="margin: 10px 0; padding: 10px; border-left: 4px solid ${strengthColor}; background: #f8f9fa;">
                            <strong>Algorithm ${algId}: ${info.name}</strong><br>
                            <small>Strength: ${info.strength} | ${info.recommended ? '‚úÖ Recommended' : '‚ùå Not Recommended'}</small><br>
                            <small style="color: #666;">${info.note}</small>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // DNS Records
            if (data.records) {
                html += `
                    <div class="section-header">üìã DNSSEC Records</div>
                    <div class="subsection">
                `;
                
                // DNSKEY Records
                if (data.records.dnskey && data.records.dnskey.length > 0) {
                    html += `
                        <h4>üîë DNSKEY Records (${data.records.dnskey.length} found)</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                                <tr style="background: #e9ecef;">
                                    <th style="padding: 8px; border: 1px solid #dee2e6;">Key Tag</th>
                                    <th style="padding: 8px; border: 1px solid #dee2e6;">Algorithm</th>
                                    <th style="padding: 8px; border: 1px solid #dee2e6;">Flags</th>
                                    <th style="padding: 8px; border: 1px solid #dee2e6;">Type</th>
                                </tr>
                    `;
                    data.records.dnskey.forEach(key => {
                        const keyType = (key.flags & 1) ? 'KSK' : 'ZSK';
                        html += `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${key.key_tag}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${key.algorithm}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${key.flags}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${keyType}</td>
                            </tr>
                        `;
                    });
                    html += '</table></div>';
                }
                
                // DS Records
                if (data.records.ds && data.records.ds.length > 0) {
                    html += `
                        <h4>üîó DS Records (${data.records.ds.length} found)</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                                <tr style="background: #e9ecef;">
                                    <th style="padding: 8px; border: 1px solid #dee2e6;">Key Tag</th>
                                    <th style="padding: 8px; border: 1px solid #dee2e6;">Algorithm</th>
                                    <th style="padding: 8px; border: 1px solid #dee2e6;">Digest Type</th>
                                    <th style="padding: 8px; border: 1px solid #dee2e6;">Digest (first 32 chars)</th>
                                </tr>
                    `;
                    data.records.ds.forEach(ds => {
                        html += `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${ds.key_tag}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${ds.algorithm}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${ds.digest_type}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6; font-family: monospace; font-size: 0.85em;">${ds.digest ? ds.digest.substring(0, 32) + '...' : 'N/A'}</td>
                            </tr>
                        `;
                    });
                    html += '</table></div>';
                } else {
                    html += `<h4>üîó DS Records</h4><p style="color: #dc3545;">‚ùå No DS records found in parent zone</p>`;
                }
                
                html += '</div>';
            }
            
            // TLSA/DANE Analysis (comprehensive) - only show if feature is enabled
            if (window.SHOW_TLSA_DANE === true && data.detailed_analysis && data.detailed_analysis.tlsa_analysis) {
                const tlsaAnalysis = data.detailed_analysis.tlsa_analysis;
                html += `
                    <div class="section-header">üîí TLSA/DANE Analysis</div>
                    <div class="subsection">
                `;
                
                if (tlsaAnalysis.error) {
                    html += `<p style="color: #dc3545;">‚ùå TLSA analysis failed: ${tlsaAnalysis.error}</p>`;
                } else if (tlsaAnalysis.validation_result) {
                    const result = tlsaAnalysis.validation_result;
                    
                    // TLSA Records
                    if (result.tlsa_records && result.tlsa_records.length > 0) {
                        html += `
                            <h4>üìã TLSA Records (${result.tlsa_records.length} found)</h4>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                                    <tr style="background: #e9ecef;">
                                        <th style="padding: 8px; border: 1px solid #dee2e6;">Usage</th>
                                        <th style="padding: 8px; border: 1px solid #dee2e6;">Selector</th>
                                        <th style="padding: 8px; border: 1px solid #dee2e6;">Matching</th>
                                        <th style="padding: 8px; border: 1px solid #dee2e6;">Data (first 16 chars)</th>
                                    </tr>
                        `;
                        result.tlsa_records.forEach(record => {
                            html += `
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">${record.usage}</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">${record.selector}</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">${record.matching_type}</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6; font-family: monospace; font-size: 0.85em;">${record.certificate_data ? record.certificate_data.substring(0, 16) + '...' : 'N/A'}</td>
                                </tr>
                            `;
                        });
                        html += '</table></div>';
                    } else {
                        html += '<h4>üìã TLSA Records</h4><p style="color: #6c757d;">üí° No TLSA records found</p>';
                    }
                    
                    // Certificate Information
                    if (result.certificate_info) {
                        const cert = result.certificate_info;
                        html += `
                            <h4>üîê TLS Certificate</h4>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0;">
                                <p><strong>Subject:</strong> ${cert.subject || 'N/A'}</p>
                                <p><strong>Issuer:</strong> ${cert.issuer || 'N/A'}</p>
                                <p><strong>Valid From:</strong> ${cert.not_before ? new Date(cert.not_before).toLocaleString() : 'N/A'}</p>
                                <p><strong>Valid To:</strong> ${cert.not_after ? new Date(cert.not_after).toLocaleString() : 'N/A'}</p>
                                <p><strong>Serial Number:</strong> ${cert.serial_number || 'N/A'}</p>
                                ${cert.fingerprints ? Object.entries(cert.fingerprints).map(([alg, fp]) => `<p><strong>${alg.toUpperCase()} Fingerprint:</strong> <code style="font-size: 0.9em;">${fp}</code></p>`).join('') : ''}
                            </div>
                        `;
                    } else if (result.tlsa_records && result.tlsa_records.length > 0) {
                        html += '<h4>üîê TLS Certificate</h4><p style="color: #dc3545;">‚ùå Could not retrieve TLS certificate</p>';
                    }
                    
                    // DANE Validation Results
                    if (result.dane_validation) {
                        const dane = result.dane_validation;
                        html += `
                            <h4>üõ°Ô∏è DANE Validation Results</h4>
                            <div style="background: ${dane.status === 'valid' ? '#d4edda' : '#f8d7da'}; padding: 10px; border-radius: 4px; margin: 10px 0;">
                                <p><strong>Status:</strong> ${dane.status}</p>
                                <p><strong>Valid Records:</strong> ${dane.valid_records || 0}</p>
                                <p><strong>Invalid Records:</strong> ${dane.invalid_records || 0}</p>
                        `;
                        
                        if (dane.validation_details && dane.validation_details.length > 0) {
                            html += '<h5>Validation Details:</h5><ul>';
                            dane.validation_details.forEach(detail => {
                                const statusIcon = detail.valid ? '‚úÖ' : '‚ùå';
                                html += `<li>${statusIcon} ${detail.message}</li>`;
                            });
                            html += '</ul>';
                        }
                        
                        if (dane.errors && dane.errors.length > 0) {
                            html += '<h5>Errors:</h5><ul>';
                            dane.errors.forEach(error => {
                                html += `<li style="color: #721c24;">‚ùå ${error}</li>`;
                            });
                            html += '</ul>';
                        }
                        
                        html += '</div>';
                    }
                }
                
                // TLSA Recommendations from detailed analysis
                if (tlsaAnalysis.recommendations && tlsaAnalysis.recommendations.length > 0) {
                    html += `
                        <div style="background: #d1ecf1; border: 1px solid #b8daff; border-radius: 5px; padding: 15px; margin: 15px 0;">
                            <h4 style="color: #0c5460; margin-bottom: 10px;">üí° TLSA/DANE Recommendations</h4>
                            <ul style="margin: 0; color: #0c5460;">
                    `;
                    tlsaAnalysis.recommendations.forEach(rec => {
                        html += `<li>${rec}</li>`;
                    });
                    html += '</ul></div>';
                }
                
                // Add educational content about TLSA/DANE ONLY if the feature flag is enabled
                if (window.SHOW_TLSA_DANE === true) {
                    html += `
                        <div style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 5px; padding: 15px; margin: 15px 0;">
                            <h4 style="color: #004085; margin-bottom: 10px;">üìö About TLSA/DANE</h4>
                            <p style="margin: 10px 0; color: #004085; line-height: 1.5;">
                                <strong>DANE (DNS-based Authentication of Named Entities)</strong> uses TLSA records to bind TLS certificates 
                                to domain names via DNS. This provides an additional layer of security by allowing domain owners to 
                                specify which certificates are authorized for their domain.
                            </p>
                            <div style="margin: 15px 0;">
                                <h5 style="color: #004085; margin-bottom: 8px;">üîó Learn More:</h5>
                                <ul style="margin: 0; color: #004085; line-height: 1.6;">
                                    <li><a href="https://tools.ietf.org/html/rfc6698" target="_blank" style="color: #0066cc;">RFC 6698: DANE Specification</a></li>
                                    <li><a href="https://tools.ietf.org/html/rfc7671" target="_blank" style="color: #0066cc;">RFC 7671: DANE Deployment Guide</a></li>
                                    <li><a href="https://www.internetsociety.org/deploy360/dnssec/dane/" target="_blank" style="color: #0066cc;">Internet Society DANE Guide</a></li>
                                    <li><a href="https://ssl-tools.net/tlsa-generator" target="_blank" style="color: #0066cc;">TLSA Record Generator Tool</a></li>
                                    <li><a href="https://dane.sys4.de/" target="_blank" style="color: #0066cc;">DANE/TLSA Validator Tool</a></li>
                                </ul>
                            </div>
                            <div style="margin: 15px 0;">
                                <h5 style="color: #004085; margin-bottom: 8px;">üõ†Ô∏è Implementation Steps:</h5>
                                <ol style="margin: 0; color: #004085; line-height: 1.6;">
                                    <li>Ensure your domain has DNSSEC enabled</li>
                                    <li>Generate TLSA records for your certificates</li>
                                    <li>Add TLSA records to your DNS zone</li>
                                    <li>Test DANE validation</li>
                                    <li>Monitor and maintain TLSA records</li>
                                </ol>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
            } else if (window.SHOW_TLSA_DANE === true && data.tlsa_summary) {
                // Basic TLSA summary if detailed analysis not available - only show if feature is enabled
                html += `
                    <div class="section-header">üîí TLSA/DANE Summary</div>
                    <div class="subsection">
                        <p><strong>Status:</strong> ${data.tlsa_summary.status}</p>
                        <p><strong>TLSA Records Found:</strong> ${data.tlsa_summary.records_found}</p>
                        <p><strong>DANE Status:</strong> ${data.tlsa_summary.dane_status}</p>
                        <p style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; font-style: italic;">${data.tlsa_summary.message}</p>
                    </div>
                `;
            }
            
            // Raw DNS Queries
            if (data.detailed_analysis && data.detailed_analysis.raw_dns_queries) {
                html += `
                    <div class="section-header">üåê Raw DNS Queries</div>
                    <div class="subsection">
                `;
                data.detailed_analysis.raw_dns_queries.forEach(query => {
                    html += `
                        <div class="dns-query">
                            <div class="query-header">
                                ${query.type} query for ${query.zone} 
                                <span style="float: right;">${query.response_time_ms}ms</span>
                            </div>
                            <div class="query-response">${query.response || query.error || 'No response'}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Query Timing
            if (data.detailed_analysis && data.detailed_analysis.query_timing) {
                html += `
                    <div class="section-header">‚è±Ô∏è Query Performance</div>
                    <div class="timing-info">
                `;
                Object.entries(data.detailed_analysis.query_timing).forEach(([query, time]) => {
                    html += `<p><strong>${query}:</strong> ${time}ms</p>`;
                });
                html += '</div>';
            }
            
            // Troubleshooting
            if (data.detailed_analysis && data.detailed_analysis.troubleshooting && data.detailed_analysis.troubleshooting.length > 0) {
                html += `
                    <div class="troubleshooting">
                        <h4>üõ†Ô∏è Troubleshooting Guide</h4>
                        <ul>
                `;
                data.detailed_analysis.troubleshooting.forEach(item => {
                    html += `<li>${item}</li>`;
                });
                html += '</ul></div>';
            }
            
            // Recommendations
            if (data.detailed_analysis && data.detailed_analysis.recommendations && data.detailed_analysis.recommendations.length > 0) {
                html += `
                    <div class="recommendations">
                        <h4>üí° Recommendations</h4>
                        <ul>
                `;
                data.detailed_analysis.recommendations.forEach(item => {
                    html += `<li>${item}</li>`;
                });
                html += '</ul></div>';
            }
            
            // Errors
            if (data.errors && data.errors.length > 0) {
                html += `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; padding: 15px; margin: 15px 0;">
                        <h4 style="color: #721c24; margin-bottom: 10px;">‚ö†Ô∏è Errors Encountered</h4>
                        <ul style="margin: 0; color: #721c24;">
                `;
                data.errors.forEach(error => {
                    html += `<li>${error}</li>`;
                });
                html += '</ul></div>';
            }
            
            html += '</div>';
            
            // Add action buttons
            html += `
                <div style="margin: 30px 0; text-align: center;">
                    <button onclick="performDetailedAnalysis('${data.domain}')" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 0 5px;">üîÑ Refresh Analysis</button>
                    <a href="/${data.domain}" style="padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px; margin: 0 5px;">‚Üê Basic Analysis</a>
                    <a href="/api/validate/${data.domain}/detailed" target="_blank" style="padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 4px; margin: 0 5px;">üìÑ Raw JSON</a>
                </div>
            `;
            
            container.innerHTML = html;
            console.log('‚úÖ displayDetailedResults completed successfully');
            
            } catch (error) {
                console.error('‚ùå Error in displayDetailedResults:', error);
                container.innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; padding: 15px; color: #721c24;">
                        <h3>‚ùå Display Error</h3>
                        <p>Error displaying results: ${error.message}</p>
                        <p><small>Check browser console for details</small></p>
                        <pre style="font-size: 0.8em; background: #f1f1f1; padding: 10px; border-radius: 3px; margin: 10px 0;">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            }
        }
        
        function getStatusClass(status) {
            const classes = {
                'valid': 'success',
                'invalid': 'danger',
                'insecure': 'secondary',
                'error': 'warning'
            };
            return classes[status] || 'secondary';
        }
        
        function getStatusIcon(status) {
            const icons = {
                'valid': '‚úÖ',
                'invalid': '‚ùå',
                'insecure': 'üîì',
                'error': '‚ö†Ô∏è'
            };
            return icons[status] || '‚ùì';
        }
        
        function getStatusColor(status) {
            const colors = {
                'valid': '#28a745',
                'invalid': '#dc3545',
                'insecure': '#6c757d',
                'error': '#ffc107'
            };
            return colors[status] || '#6c757d';
        }
    </script>
    
    {% if show_attribution %}
    <footer style="text-align: center; padding: 20px 0; margin-top: 40px; color: #6c757d; font-size: 0.9em; border-top: 1px solid #e9ecef;">
        Built with ‚ù§Ô∏è by 
        <a href="https://bondit.dk" target="_blank" rel="noopener noreferrer" style="color: #3498db; text-decoration: none;">BondIT ApS</a> | 
        <a href="https://github.com/BondIT-ApS/dnssec-validator" target="_blank" rel="noopener noreferrer" style="color: #3498db; text-decoration: none;">View on GitHub</a>
    </footer>
    {% endif %}
</body>
</html>
